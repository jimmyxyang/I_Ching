<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>易經數字卦</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f4f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #4b5563;
      --line: #d1d5db;
      --accent: #0f766e;
      --accent-hover: #0b5f59;
      --result-bg: #fbfdff;
      --shadow: rgba(31, 41, 55, 0.08);
    }

    :root[data-theme="dark"] {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --line: #374151;
      --accent: #0ea5a4;
      --accent-hover: #0b8d8c;
      --result-bg: #0b1220;
      --shadow: rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: #000000;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 16px;
    }

    .panel {
      width: min(100%, 420px);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow);
      padding: 18px;
    }

    h1 {
      margin: 0 0 14px;
      text-align: center;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }

    .row {
      display: grid;
      grid-template-columns: 38px 1fr;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
    }

    label {
      font-weight: 700;
      color: var(--muted);
      text-align: right;
    }

    input[type="text"] {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 1.05rem;
      padding: 10px 12px;
      text-align: center;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.16);
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .tools-line {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .theme-btn {
      width: auto;
      min-width: 128px;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--text);
      background: transparent;
    }

    .theme-btn:hover {
      background: var(--result-bg);
    }

    .copy-line {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-weight: 700;
    }

    .copy-line input { width: 18px; height: 18px; }

    button {
      width: 100%;
      border: 0;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 700;
      background: var(--accent);
      color: white;
      cursor: pointer;
    }

    button:hover { background: var(--accent-hover); }

    .result {
      margin-top: 12px;
      min-height: 180px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      background: var(--result-bg);
      white-space: pre-wrap;
      font-family: "Consolas", "Courier New", monospace;
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .hint {
      margin-top: 10px;
      font-size: 0.88rem;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <main class="panel">
    <h1>易經數字卦</h1>

    <div class="row">
      <label for="n1">1:</label>
      <input id="n1" type="text" maxlength="3" inputmode="numeric" autocomplete="off" aria-label="第一組數字">
    </div>

    <div class="row">
      <label for="n2">2:</label>
      <input id="n2" type="text" maxlength="3" inputmode="numeric" autocomplete="off" aria-label="第二組數字">
    </div>

    <div class="row">
      <label for="n3">3:</label>
      <input id="n3" type="text" maxlength="3" inputmode="numeric" autocomplete="off" aria-label="第三組數字">
    </div>

    <div class="actions">
      <div class="tools-line">
        <button id="themeBtn" class="theme-btn" type="button">切換深色</button>
        <label class="copy-line">
          <input id="ckCopy" type="checkbox" checked>
          複製
        </label>
      </div>
      <button id="calcBtn" type="button">計算</button>
    </div>

    <pre id="result" class="result"></pre>
    <div class="hint">請填入三組三位數字（僅限 0-9）</div>
  </main>

  <script>
    const inputs = ["n1", "n2", "n3"].map((id) => document.getElementById(id));
    const resultEl = document.getElementById("result");
    const calcBtn = document.getElementById("calcBtn");
    const ckCopy = document.getElementById("ckCopy");
    const themeBtn = document.getElementById("themeBtn");

    const GOSSIP_CHAR = {
      1: "乾", 2: "兌", 3: "離", 4: "震", 5: "巽", 6: "坎", 7: "艮", 8: "坤"
    };

    const GOSSIP_ICON = {
      1: "———\n———\n———\n",
      2: "—  —\n———\n———\n",
      3: "———\n—  —\n———\n",
      4: "—  —\n—  —\n———\n",
      5: "———\n———\n—  —\n",
      6: "—  —\n———\n—  —\n",
      7: "———\n—  —\n—  —\n",
      8: "—  —\n—  —\n—  —\n"
    };

    const GOSSIP_HANG = {
      11: { name: "乾卦", page: 62 }, 88: { name: "坤卦", page: 85 }, 64: { name: "屯卦", page: 104 },
      76: { name: "蒙卦", page: 116 }, 61: { name: "需卦", page: 129 }, 16: { name: "訟卦", page: 140 },
      86: { name: "師卦", page: 151 }, 68: { name: "比卦", page: 164 }, 51: { name: "小畜卦", page: 175 },
      12: { name: "履卦", page: 188 }, 81: { name: "泰卦", page: 200 }, 18: { name: "否卦", page: 212 },
      13: { name: "同人卦", page: 224 }, 31: { name: "大有卦", page: 235 }, 87: { name: "謙卦", page: 246 },
      48: { name: "豫卦", page: 257 }, 24: { name: "隨卦", page: 268 }, 75: { name: "蠱卦", page: 280 },
      82: { name: "臨卦", page: 291 }, 58: { name: "觀卦", page: 302 }, 34: { name: "噬嗑卦", page: 315 },
      73: { name: "賁卦", page: 326 }, 78: { name: "剝卦", page: 339 }, 84: { name: "復卦", page: 350 },
      14: { name: "無妄卦", page: 363 }, 71: { name: "大畜卦", page: 374 }, 74: { name: "頤卦", page: 386 },
      25: { name: "大過卦", page: 399 }, 66: { name: "習坎卦", page: 410 }, 33: { name: "離卦", page: 423 },
      27: { name: "咸卦", page: 1012 }, 45: { name: "恆卦", page: 1023 }, 17: { name: "遯卦", page: 1035 },
      41: { name: "大壯卦", page: 1046 }, 38: { name: "晉卦", page: 1058 }, 83: { name: "明夷卦", page: 1069 },
      53: { name: "家人卦", page: 1082 }, 32: { name: "睽卦", page: 1095 }, 67: { name: "蹇卦", page: 1108 },
      46: { name: "解卦", page: 1120 }, 72: { name: "損卦", page: 1131 }, 54: { name: "益卦", page: 1143 },
      21: { name: "夬卦", page: 1155 }, 15: { name: "姤卦", page: 1166 }, 28: { name: "萃卦", page: 1178 },
      85: { name: "升卦", page: 1191 }, 26: { name: "困卦", page: 1203 }, 65: { name: "井卦", page: 1216 },
      23: { name: "革卦", page: 1229 }, 35: { name: "鼎卦", page: 1241 }, 44: { name: "震卦", page: 1253 },
      77: { name: "艮卦", page: 1265 }, 57: { name: "漸卦", page: 1276 }, 42: { name: "歸妹卦", page: 1288 },
      43: { name: "豐卦", page: 1300 }, 37: { name: "旅卦", page: 1312 }, 55: { name: "巽卦", page: 1324 },
      22: { name: "兌卦", page: 1337 }, 56: { name: "渙卦", page: 1348 }, 62: { name: "節卦", page: 1359 },
      52: { name: "中孚卦", page: 1371 }, 47: { name: "小過卦", page: 1383 }, 63: { name: "既濟卦", page: 1395 },
      36: { name: "未濟卦", page: 1406 }
    };

    for (const input of inputs) {
      input.addEventListener("input", () => {
        input.value = input.value.replace(/\D/g, "").slice(0, 3);
      });
    }

    function getPreferredTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "light" || saved === "dark") return saved;
      return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      themeBtn.textContent = theme === "dark" ? "切換淺色" : "切換深色";
    }

    applyTheme(getPreferredTheme());

    themeBtn.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      localStorage.setItem("theme", next);
    });

    function format3(value) { return String(value).padStart(3, "0"); }
    function normalizeBy8(v) { const n = v % 8; return n === 0 ? 8 : n; }
    function normalizeBy6(v) { const n = v % 6; return n === 0 ? 6 : n; }

    function getGossipHang(up, down, onlyName) {
      const key = up * 10 + down;
      const item = GOSSIP_HANG[key];
      if (!item) {
        return onlyName ? "未知卦象" : "\n[未知卦象]  無參考頁";
      }
      if (onlyName) {
        return item.name;
      }
      const volume = Math.floor(item.page / 1000) > 0 ? "下" : "上";
      return `\n[${item.name}]  參考 ${volume}冊: ${item.page % 1000}頁`;
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return;
        }
      } catch (_) {}

      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.opacity = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }

    calcBtn.addEventListener("click", async () => {
      if (inputs.some((input) => input.value.length < 3)) {
        alert("數字太少");
        return;
      }

      const v1 = Number(inputs[0].value);
      const v2 = Number(inputs[1].value);
      const v3 = Number(inputs[2].value);

      const v1Cal = normalizeBy8(v1);
      const v2Cal = normalizeBy8(v2);
      const v3Cal = normalizeBy6(v3);

      let msg = "";
      msg += `上卦：${format3(v2Cal)} ${GOSSIP_CHAR[v2Cal]}\n`;
      msg += `下卦：${format3(v1Cal)} ${GOSSIP_CHAR[v1Cal]}\n`;
      msg += GOSSIP_ICON[v2Cal];
      msg += GOSSIP_ICON[v1Cal];
      msg += `變卦：${format3(v3Cal)}\n`;
      msg += getGossipHang(v2Cal, v1Cal, false);
      resultEl.textContent = msg;

      if (ckCopy.checked) {
        const copyMsg = `${getGossipHang(v2Cal, v1Cal, true)} ${v3Cal}爻`;
        await copyText(copyMsg);
      }
    });
  </script>
</body>
</html>
